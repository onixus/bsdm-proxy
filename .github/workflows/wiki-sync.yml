name: Sync Wiki

on:
  push:
    branches:
      - main
    paths:
      - 'README.md'
      - '.github/workflows/wiki-sync.yml'
  workflow_dispatch:

jobs:
  sync-wiki:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Checkout Wiki
        id: checkout-wiki
        continue-on-error: true
        run: |
          git clone https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.wiki.git wiki || true
          if [ -d "wiki/.git" ]; then
            echo "wiki_exists=true" >> $GITHUB_OUTPUT
          else
            echo "wiki_exists=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Create Installation Guide from template
        if: steps.checkout-wiki.outputs.wiki_exists == 'true'
        run: |
          cat > wiki/Installation-Guide.md << 'EOFMARKER'
          # Ð ÑƒÐºÐ¾Ð²Ð¾Ð´ÑÑ‚Ð²Ð¾ Ð¿Ð¾ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐµ BSDM-Proxy
          
          ## Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ðµ Ñ‚Ñ€ÐµÐ±Ð¾Ð²Ð°Ð½Ð¸Ñ
          
          **ÐœÐ¸Ð½Ð¸Ð¼Ð°Ð»ÑŒÐ½Ñ‹Ðµ:**
          - CPU: 2 ÑÐ´Ñ€Ð°
          - RAM: 4 GB
          - Ð”Ð¸ÑÐº: 10 GB ÑÐ²Ð¾Ð±Ð¾Ð´Ð½Ð¾Ð³Ð¾ Ð¼ÐµÑÑ‚Ð°
          - OS: Linux (Ubuntu 20.04+), macOS 11+, Windows 10/11 + WSL2
          
          **Ð ÐµÐºÐ¾Ð¼ÐµÐ½Ð´ÑƒÐµÐ¼Ñ‹Ðµ Ð´Ð»Ñ production:**
          - CPU: 4+ ÑÐ´Ñ€Ð°
          - RAM: 8+ GB
          - Ð”Ð¸ÑÐº: 50+ GB (SSD)
          - Network: 1 Gbps+
          
          ## Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
          
          ### Docker
          
          ```bash
          # Ubuntu/Debian
          curl -fsSL https://get.docker.com -o get-docker.sh
          sudo sh get-docker.sh
          sudo usermod -aG docker $USER
          
          # macOS
          brew install --cask docker
          ```
          
          ### Rust (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾)
          
          ```bash
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
          source $HOME/.cargo/env
          ```
          
          ## ðŸš€ Ð‘Ñ‹ÑÑ‚Ñ€Ñ‹Ð¹ ÑÑ‚Ð°Ñ€Ñ‚
          
          ### 1. ÐšÐ»Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ
          
          ```bash
          git clone https://github.com/onixus/bsdm-proxy.git
          cd bsdm-proxy
          ```
          
          ### 2. Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ð²
          
          ```bash
          mkdir -p certs && cd certs
          openssl genrsa -out ca.key 4096
          openssl req -new -x509 -days 3650 -key ca.key -out ca.crt -subj "/C=RU/O=BSDM/CN=BSDM CA"
          cd ..
          ```
          
          ### 3. Ð—Ð°Ð¿ÑƒÑÐº
          
          ```bash
          docker-compose up -d
          docker-compose ps
          ```
          
          ### 4. Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° CA
          
          ```bash
          # Linux
          sudo cp certs/ca.crt /usr/local/share/ca-certificates/bsdm-ca.crt
          sudo update-ca-certificates
          
          # macOS  
          sudo security add-trusted-cert -d -r trustRoot -k /Library/Keychains/System.keychain certs/ca.crt
          ```
          
          ### 5. ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ°
          
          ```bash
          curl -x https://localhost:1488 https://httpbin.org/get
          curl http://localhost:9200/http-cache/_count?pretty
          ```
          
          ## Troubleshooting
          
          | ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼Ð° | Ð ÐµÑˆÐµÐ½Ð¸Ðµ |
          |---------|----------|
          | Docker Ð½Ðµ Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ÑÑ | `docker-compose down -v && docker-compose up -d` |
          | OpenSearch OOM | Ð£Ð²ÐµÐ»Ð¸Ñ‡ÑŒÑ‚Ðµ `OPENSEARCH_JAVA_OPTS=-Xms1g -Xmx1g` |
          | Kafka timeout | `docker-compose restart kafka` |
          | Ð¡ÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ñ‹ | `rm -rf certs/* && # Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€Ð¸Ñ‚Ðµ ÑˆÐ°Ð³ 2` |
          
          ## ÐŸÑ€Ð¸Ð¼ÐµÑ€Ñ‹
          
          ### Python
          ```python
          import requests
          proxies = {'https': 'https://localhost:1488'}
          requests.get('https://example.com', proxies=proxies, verify='certs/ca.crt')
          ```
          
          ### Node.js
          ```javascript
          const agent = new https.Agent({host: 'localhost', port: 1488, ca: fs.readFileSync('certs/ca.crt')});
          ```
          
          ---
          
          [â† Home](Home) | [ÐŸÐ¾Ð»Ð½Ñ‹Ð¹ README](https://github.com/onixus/bsdm-proxy#readme)
          EOFMARKER
      
      - name: Commit and push to Wiki
        if: steps.checkout-wiki.outputs.wiki_exists == 'true'
        working-directory: wiki
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Installation-Guide.md
          if ! git diff --staged --quiet; then
            git commit -m "docs: sync installation guide from main"
            git push origin master
            echo "Wiki updated: https://github.com/${{ github.repository }}/wiki/Installation-Guide"
          fi
      
      - name: Wiki not initialized
        if: steps.checkout-wiki.outputs.wiki_exists == 'false'
        run: |
          echo "Wiki not initialized. Create first page at:"
          echo "https://github.com/${{ github.repository }}/wiki"
          exit 1
